      SUBROUTINE CALCY(ICH)
      INCLUDE 'HEAD'
	DIMENSION TEMP(IX,JY)
	DO 5 I=1,NI
	DO 5 J=1,NJ
	IF(ICH.EQ.1)TEMP(I,J)=CPT(I,J)
	IF(ICH.EQ.2)TEMP(I,J)=YCH4(I,J)
	IF(ICH.EQ.3)TEMP(I,J)=YO2(I,J)
	IF(ICH.EQ.4)TEMP(I,J)=YCO2(I,J)
	IF(ICH.EQ.5)TEMP(I,J)=YH2O(I,J)
5     CONTINUE	
C-----------Interior points
	DO 10 J=2,NJM1
	DO 10 I=2,NIM1
C-----------Calculate Areas and Volume
      AREAS=SWE(I)*RV(J)
	AREAN=SWE(I)*RV(J+1)
	AREAW=SSN(J)*RCV(J)
	AREAE=SSN(J)*RCV(J)
	VOL=SWE(I)*SSN(J)*RCV(J)
C---------Calculate Convection Coefficients
      CS=(DEN(I,J-1)*XICVS(J)+DEN(I,J)*XICVN(J))*V(I,J)*AREAS
	CN=(DEN(I,J)*XICVS(J+1)+DEN(I,J+1)*XICVN(J+1))*V(I,J+1)*AREAN
	CW=(DEN(I-1,J)*XICUW(I)+DEN(I,J)*XICUE(I))*U(I,J)*AREAW
	CE=(DEN(I,J)*XICUW(I+1)+DEN(I+1,J)*XICUE(I+1))*U(I+1,J)*AREAE
	REMASS=CN-CS+CE-CW
C---------Calculate Diffusion Coeffients
      IF(ICH.EQ.1)PR=PRT
	IF(ICH.EQ.2)PR=PRCH4
	IF(ICH.EQ.3)PR=PRO2
	IF(ICH.EQ.4)PR=PRCO2
	IF(ICH.EQ.5)PR=PRH2O
      VISS=(VIS(I,J-1)*XICVS(J)+VIS(I,J)*XICVN(J))/PR
	VISN=(VIS(I,J)*XICVS(J+1)+VIS(I,J+1)*XICVN(J+1))/PR
	VISW=(VIS(I-1,J)*XICUW(I)+VIS(I,J)*XICUE(I))/PR
	VISE=(VIS(I,J)*XICUW(I+1)+VIS(I+1,J)*XICUE(I+1))/PR
	DS=VISS*AREAS/DYSP(J)+1E-30
	DN=VISN*AREAN/DYPN(J)+1E-30
	DW=VISW*AREAW/DXWP(I)+1E-30
	DE=VISE*AREAE/DXPE(I)+1E-30
C---------Calculate the Peclet Number
      PS=CS/DS
	PN=CN/DN
	PW=CW/DW
	PE=CE/DE
C---------ASSEMBLE MAIN COEFFICIENTS
      AS(I,J)=DS*AMAX1(0.,(1.-.1*ABS(PS))**5)+AMAX1(CS,0.)
	AN(I,J)=DN*AMAX1(0.,(1.-.1*ABS(PN))**5)+AMAX1(-CN,.0)
	AW(I,J)=DW*AMAX1(0.,(1.-.1*ABS(PW))**5)+AMAX1(CW,0.)
	AE(I,J)=DE*AMAX1(0.,(1.-.1*ABS(PE))**5)+AMAX1(-CE,.0)
c      AS(I,J)=AMAX1(ABS(0.5*CS),DS)+0.5*CS
c	AN(I,J)=AMAX1(ABS(0.5*CN),DN)-0.5*CN
c	AW(I,J)=AMAX1(ABS(0.5*CW),DW)+0.5*CW
c	AE(I,J)=AMAX1(ABS(0.5*CE),DE)-0.5*CE
      IF(REMASS.LE.0.0)THEN
	SP(I,J)=0.0
      SU(I,J)=-REMASS*TEMP(I,J)
	ELSE
	SP(I,J)=-REMASS
	SU(I,J)=0.0
	END IF
C---------Calculate The Source
      CEBU=1.0
	QCH4=6.0E7
	BTCH4=1.0
	BTO2=16.0/64.0
	BTCO2=16.0/44.0
	BTH2O=16.0/36.0
	IF(ICH.EQ.1)THEN
      WARR=1.6E10*DEN(I,J)**2*YCH4(I,J)*YO2(I,J)*
     1	EXP(-1.081E5/(8.314*T(I,J)))
	WEBU=CEBU*DEN(I,J)*ED(I,J)/(TE(I,J)+1E-30)*
     1	AMIN1(YCH4(I,J),YO2(I,J)*BTO2)
      WCH4(I,J)=-AMIN1(WARR,WEBU)
C     WCH4(I,J)=-WARR
	END IF
	IF(ICH.EQ.1)SU(I,J)=SU(I,J)-WCH4(I,J)*QCH4*VOL
	IF(ICH.EQ.2)SU(I,J)=SU(I,J)+WCH4(I,J)*VOL
	IF(ICH.EQ.3)SU(I,J)=SU(I,J)+WCH4(I,J)*VOL/BTO2
	IF(ICH.EQ.4)SU(I,J)=SU(I,J)-WCH4(I,J)*VOL/BTCO2
	IF(ICH.EQ.5)SU(I,J)=SU(I,J)-WCH4(I,J)*VOL/BTH2O
10    CONTINUE
C---------Problem Modification
      IPCH=ICH+5
      CALL PRMOD(IPCH)
C---------Residual Source Calculation
      RESORX=0.0
      DO 20 J=2,NJM1
	DO 20 I=2,NIM1
	AP(I,J)=AN(I,J)+AS(I,J)+AW(I,J)+AE(I,J)-SP(I,J)	
	RESOR=AS(I,J)*TEMP(I,J-1)+AN(I,J)*TEMP(I,J+1)+
     1      AW(I,J)*TEMP(I-1,J)+AE(I,J)*TEMP(I+1,J)+
     1      SU(I,J)-AP(I,J)*TEMP(I,J)
C      IF(ABS(SP(I,J)).GE.1E25)RESOR=0.0
      RESORX=RESORX+ABS(RESOR)                	
20    CONTINUE
      IF(ICH.EQ.1)RESORT=RESORX
	IF(ICH.EQ.2)RESCH4=RESORX
	IF(ICH.EQ.3)RESOO2=RESORX
	IF(ICH.EQ.4)RESCO2=RESORX
	IF(ICH.EQ.5)RESH2O=RESORX
C---------Under-Relaxation
      IF(ICH.EQ.1)URF=URFT
	IF(ICH.EQ.2)URF=UCH4
	IF(ICH.EQ.3)URF=URO2
	IF(ICH.EQ.4)URF=UCO2
	IF(ICH.EQ.5)URF=UH2O
	DO 30 J=2,NJM1
	DO 30 I=2,NIM1
	AP(I,J)=AP(I,J)/URF
      SU(I,J)=SU(I,J)+(1.-URF)*AP(I,J)*TEMP(I,J)
30    CONTINUE
C---------Solution of Difference Equation
      IF(ICH.EQ.1)NSWP=NSWPT
	IF(ICH.EQ.2)NSWP=NSCH4
	IF(ICH.EQ.3)NSWP=NSWO2
	IF(ICH.EQ.4)NSWP=NSCO2
	IF(ICH.EQ.5)NSWP=NSH2O   
      DO 50 N=1,NSWP
	CALL LISOLV(2,NIM1,2,NJM1,IT,JT,TEMP,1)
50    CONTINUE
      DO 60 I=1,NI
	TEMP(I,1)=TEMP(I,2)
60	CONTINUE
      DO 70 J=1,NJ
	TEMP(NI,J)=TEMP(NIM1,J)
70    CONTINUE
	DO 90 I=1,NI
	DO 90 J=1,NJ
	IF(ICH.EQ.1)CPT(I,J)=TEMP(I,J)
	IF(ICH.EQ.2)YCH4(I,J)=TEMP(I,J)
	IF(ICH.EQ.3)YO2(I,J)=TEMP(I,J)
	IF(ICH.EQ.4)YCO2(I,J)=TEMP(I,J)
	IF(ICH.EQ.5)YH2O(I,J)=TEMP(I,J)
90    CONTINUE	
      IF(ICH.EQ.1)THEN
	DO 100 I=2,NIM1
	DO 100 J=2,NJM1
C******CP=0.167*T+1173.0
C******So, CPT=0.167*T*T+1173.0*T
C******T=(-1173.0+-SQRT(1173**2+4*0.167*CPT))/(2*0.167)	
	T(I,J)=(-1173.0+SQRT(1173.0**2+4*0.167*CPT(I,J)))/(2.*0.167)
	YN2(I,J)=1.0-YCH4(I,J)-YO2(I,J)-YCO2(I,J)-YH2O(I,J)
	XM=YCH4(I,J)/XMCH4+YO2(I,J)/XMO2+YCO2(I,J)/XMCO2+
     1   YH2O(I,J)/XMH2O+YN2(I,J)/XMN2
	DEN(I,J)=1.01325E5/(8314.6*T(I,J)*XM)
100   CONTINUE
c      DO 110 I=1,NI
c	CPT(I,1)=CPT(I,2)
c	T(I,1)=T(I,2)
c	DEN(I,1)=DEN(I,2)
c	VIS(I,1)=VIS(I,2)
c	YN2(I,1)=YN2(I,2)	
c	DEN(I,NJ)=DEN(I,NJM1)
c	YCH4(I,NJ)=YCH4(I,NJM1)
c	YO2(I,NJ)=YO2(I,NJM1)
c	YCO2(I,NJ)=YCO2(I,NJM1)
c	YH2O(I,NJ)=YH2O(I,NJM1)
c	YN2(I,NJ)=YN2(I,NJM1)
c110	CONTINUE
c      DO 120 J=1,NJ
c	CPT(NI,J)=CPT(NIM1,J)
c	T(NI,J)=T(NIM1,J)
c	DEN(NI,J)=DEN(NIM1,J)
c	IF(J.GE.11)THEN
c	DEN(1,J)=DEN(2,J)
c	YCH4(1,J)=YCH4(2,J)
c	YO2(1,J)=YO2(2,J)
c	YCO2(1,J)=YCO2(2,J)
c	YH2O(1,J)=YH2O(2,J)
c	YN2(1,J)=YN2(2,J)
c	END IF
c	VIS(NI,J)=VIS(NIM1,J)
c	YN2(NI,J)=YN2(NIM1,J)	
c120   CONTINUE
      END IF
      RETURN
	END